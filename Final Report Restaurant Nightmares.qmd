---
title: "Final Report Restaurant Nightmares"
author:  Caroline Guirand, Tyler Lara, Haley Vargas, Matthew Kelsall
format:
    html:
      echo: false
---

```{r}
#| warning: false
#| echo: false
#| message: false

library(readxl); library(tibble); library(dplyr)
library(tidyverse); library(ggplot2); library(reshape2)
library(lubridate); library(scales)
library(forcats); library(patchwork); library(scales);
library(DT); library(glue); library(httr2)

community_health_df <- function() {
  # Source url and file names
  src_url  <- "https://www.nyc.gov/assets/doh/downloads/excel/episrv/2022-chp-pud.xlsx"
  src_name <- basename(src_url)  
  
  # Destination paths
  dest_dir  <- file.path("data", "finproj")
  dest_file <- file.path(dest_dir, src_name)
  
  if (!dir.exists(dest_dir)) {
    dir.create(dest_dir, recursive = TRUE)
  }
  
  if (!file.exists(dest_file)) {
    message("Downloading: ", src_url)

    utils::download.file(src_url, dest_file, mode = "wb", quiet = TRUE)
    message("File saved to: ", dest_file)
  } else {
    message("File already exists in destination: ", dest_file)
  }
  

  df <- readxl::read_excel(dest_file, sheet = "CHP_all_data", skip = 1)
  

  df <- df[-c(66:69), ]

  return(df)
} 

community_health<-community_health_df()


community_health <- community_health |>
  mutate(across(where(is.character), ~ na_if(., "n/a")))

is_borough_level <- community_health$ID %in% 0:5
#Bourough rows
ch_boroughs <- subset(community_health, is_borough_level)
#Community District rows
ch_neighbor <- subset(community_health, !is_borough_level)



```

1.  Motivations and Importance of Question

Our communities are critical to our lives as residents of New York City’s diverse boroughs. Each neighborhood has its own unique character, population, and resources, which in turn impact the experiences and well-being of its residents. As New Yorkers, we want to live in neighborhoods that are healthy, vibrant, and thriving. One key indicator of a healthy community is food safety, since restaurants play a critical role in public health and day-to-day life. Restaurants not only provide nutrition but also contribute to social life, employment, and the local economy.

This project addresses a crucial question for New Yorkers: How does restaurant quality relate to community health across New York City's neighborhoods? Understanding how poor restaurant quality, whether due to low food quality, a high prevalence of fast food, or frequent critical health violations, may affect our community health is important. Poor restaurant quality could be linked to higher rates of diet-related conditions like diabetes, obesity, and other chronic illnesses, which have long-term implications for individuals and the healthcare system.

Economic factors may also play a role in restaurant quality. Neighborhoods with higher poverty rates or greater rent burdens could face more challenges in supporting high-quality restaurant options. This could lead to a higher prevalence of fast food or restaurants with poor health inspection results. Exploring these patterns can help identify whether economic stress in a community is linked to poorer food quality choices and, in turn, public health outcomes.

By examining these relationships, we aim to provide insights that inform public health policies, guide interventions, and support access to safe and nutritious food across all neighborhoods. Understanding these patterns can empower communities and policymakers to take actions that promote safer, healthier, and more vibrant communities for all New Yorkers.

2.  Briefly how the specific analyses help to address the motivating question

3.  The choice of data used, including discussion of any limitations

In order to find out the answers to the question, the team used 3 datasets from different sources. The first of these datasets is New York City Community Health Profiles from the [NYC Health Webstie](https://www.nyc.gov/site/doh/data/data-publications/profiles.page). This dataset was made in 2022, and is a collective sum of data from different areas of government and public organizations. These include the American Community Survey (ACS), NYC DOHMH,the NYC Department of Education, the NYC Mayor’s Office for Economic Opportunity, and the NYC Housing and Vacancy Survey (HVS). This excel file is very comprehensive, with 6 different "pages" and the first 3 pages providing technical and metadata. The last 3 pages are community health profiles, the cause of premature death, and ranking of cancer data. However, this study will only be using the community health profiles for analyzing due to the last 2 pages (premature death and cancer data) do not having data related to the study. The community health profiles dataset contains 59 community districts making up NYC, and over 50 different measures of public health. These measures follow under demographics, economic or societal conditions, access to health, and health outcomes. This data becomes bloated Though, it has a total of 196 columns because some measures include confidence intervals, notes about the measure, or comparing if the district is higher or lower than to the average in NYC.

This study will only be using columns that relate to the question. Through this, there are only a few that remain important to the study. These include columns like poverty, hypertension, obesity, diabetes, and self-reported health. As seen below, all of these values are in percentages. There are some limitations to this data, especially as it has multiple different sources that likely used different methods to obtain the data. For example, there is a self-reported health column which is unreliable because people could underestimate or overestimate their health condition. As well, because this data is turned into a sum or average per district, analyzing cannot go further in depth. Finally, the data sources all come from different years from 2014 to 2022. Using this data with other datasets means possibly comparing measures from 2016 to ones in 2025, thus leading to inaccurate findings. 


```{r}
#| fig-width: 10
#| fig-height: 3
#| out-width: 100%

ch_neighbor|>
  select(
    Name,
    Poverty, Unemployment, Rent_Burden,  Obesity, Hypertension)|>
  mutate(
    across(
      where(is.numeric) & !any_of("ID"),
      ~ percent(.x, accuracy = 0.01, scale = 1)
    )
  )|>
  rename(`Rent Burden`=Rent_Burden)|>
  datatable(options=list(pageLength=5, scrollX=TRUE), 
            rownames = FALSE, selection = 'none' )

```

The next dataset is from the [Department of Health and Mental Hygiene (DOHMH)](https://data.cityofnewyork.us/Health/DOHMH-New-York-City-Restaurant-Inspection-Results/43nn-pn8j/about_data). It contains every violation citation given out from 2015 to 2025, including letter grades, violation descriptions, location, and inspection dates. It has a total of 27 columns and 20,998 restaurants recorded, with each row being a restaurant citation. Overall, the data is complete and consistent, though the DOHMH notes that because the data is compiled from multiple data systems there might be some illogical values. As well, the DOHMH states that "establishments with the inspection date of 1/1/1990 are new and have not received an inspection". It is important to keep both of these statements in mind to accurately analyze this dataset. There is another limitation present, namely the lack of a district column. Although this leads to some difficulties, there is a semi-solution of using zip codes to create the district. The main issue with this is that not all zip codes correctly make up a district, meaning analyzing by the district level means some values like the number of restaurants in that district might be inflated or be deflated compared to the actual number. 

The final dataset is from NYC's [311 Food Poisoning service request records](https://data.cityofnewyork.us/Social-Services/food-poisoning/gjkf-etq5/about_data). It contains site‑specific complaints residents submit to 311 when they believe an illness resulted from food consumed at an establishment or event. These records are part of a citywide feed that is automatically refreshed and covers requests from 2010 to the present, meaning it will be easier to use data from the same year as the previous datasets. In terms of structure, the table includes multiple 311 fields that are useful for analysis and joining. This includes Created and Closed Date, Complaint Type, Location Type, Address, Borough, and Status. For our question, these complaints serve as an approximate indicator of suspected food‑borne illness at the neighborhood level. 

This dataset also has multiple limitations. First, 311 submissions are self‑reported and may reflect perception or recall bias. For example, the food item or venue people identify might not be the actual source of the illness. NYC311 explicitly notes that while reports are investigated, not every establishment is inspected before its next scheduled inspection, so a complaint does not guarantee an immediate site visit. Additionally, This dataset has a similar issue to the previous one, where there is no district column. Now, there is the "City" column that ranges from indicating New York to a borough like flushing but it does not include district. So we can also group these semi-correctly into districts by using ZIP codes in order to compare with the Community Health Profile dataset.


4.  Visualization of most important findings

5.  Relation to Prior Work

6.  Potential Next Steps
